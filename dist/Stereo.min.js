/* Stereo
*  
* Copyright (c) 2013 Johannes BurstrÃ¶m, johannes@ljud.org
*Stereo may be freely distributed under the MIT license. */!function(a,b,c){"use strict";if("undefined"==typeof a.Stereo){var d={options:{}};!function(){var e=function(){throw new Error('A "url" property or function must be specified')};d.SongInfo=b.Model.extend({defaults:function(){return{id:!1,title:"",artist:"",playlist:""}},_isSynced:!1,initialize:function(){this.once("change",function(){this._isSynced=!0,this.trigger("hasInfo")})},urlRoot:function(){return d.options.infoURL},getInfo:function(){this._isSynced?this.trigger("hasInfo"):this.fetch()}}),d.Song=b.Model.extend({initialize:function(a,b){this.id=a,this.options=c.extend({},b),this.info=new d.SongInfo({id:a})},play:function(){this.snd||this.createSound(),this.snd.play()},pause:function(){this.snd&&this.snd.pause()},stop:function(){this.snd&&(this.snd.stop(),this.destroySound())},seek:function(){console.log("Seek: Not implemented")},createSound:function(){var b=this;this.snd=a.soundManager.createSound({id:this.options.id,url:this.url(),onload:function(){b.trigger("load",this)},onplay:function(){b.trigger("play",this)},onpause:function(){b.trigger("pause",this)},onstop:function(){b.trigger("stop",this)},onfinish:function(){b.trigger("finish",this)},onwhileloading:function(){var a=this.bytesLoaded/this.bytesTotal;b.trigger("whileloading",this,a)},onwhileplaying:function(){var a=1==this.readyState?this.durationEstimate:this.duration,c=this.position/a;b.trigger("whileplaying",this,c)}})},destroySound:function(){a.soundManager.destroySound(this.snd.id),delete this.snd},urlRoot:function(){return d.options.urlRoot},url:function(){var a,b=this.id,d=c.result(this,"urlRoot")||c.result(this.collection,"url")||e();if(this.isNew())return d;if(d){if(a=d,0===b.indexOf("http://")||0===b.indexOf("https://")||0===b.indexOf("//"))return b;0===b.indexOf("/")&&(b=b.substr(1,b.length)),a.lastIndexOf("/")!==a.length-1&&(a+="/"),b=(a&&-1!==a.lastIndexOf("/")?a.substr(0,a.lastIndexOf("/")+1):"./")+b}return b}})}(),function(){var a=function(a){var b=this.get(a);return"undefined"==typeof b?!1:this.indexOf(b)},c=function(a,b){return(b%a+a)%a},e=function(a,b){return 0===this.length?(this._index=-1,!1):(a+=b,this._repeat?(a=c(this.length,a),this._index=a,this.at(a).id):a>=this.length||0>a?(this._index=-1,!1):(this._index=a,this.at(a).id))};d.Playlist=b.Collection.extend({model:d.Song,_repeat:!1,_index:-1,setRepeat:function(a){this._repeat=a===!0},getRepeat:function(){return this._repeat},getPrev:function(a){return e.call(this,a,-1)},getPrevById:function(b){var c=a.call(this,b);return!1===c?e.call(this,c,0):e.call(this,c,-1)},getNext:function(a){return e.call(this,a,1)},getNextById:function(b){var c=a.call(this,b);return!1===c?e.call(this,c,0):e.call(this,c,1)},getSafe:function(b){var c=a.call(this,b);return e.call(this,c,0)}})}(),d.playlist=new d.Playlist,d.Player=b.Model.extend({playlist:d.playlist,initialize:function(){this.set("playState",0),this.set("song",!1),this.listenTo(this.playlist,"remove",function(a){a.id==this.get("song")&&(this.set("playState",0),this.set("song",!1)),a.snd&&a.destroySound()})},play:function(){var a=this.getSong();a&&(this.set("playState",1),a.play())},pause:function(){var a=this.getSong();a&&(this.set("playState",2),a.pause())},stop:function(){var a=this.getSong();a&&(this.set("playState",0),a.stop())},playPause:function(a){var b=this.get("playState");a&&a!=this.get("song")&&(b>0&&this.stop(),b=0,this.setSong(a)),1==b?this.pause():this.play()},prev:function(){this._prevNext(-1)},next:function(){this._prevNext(1)},isPlaying:function(){return 1==this.get("playState")},isStopped:function(){return 0===this.get("playState")},isPaused:function(){return 2==this.get("playState")},_prevNext:function(a){var b;return b=0>a?this.playlist.getPrevById(this.get("song")):this.playlist.getNextById(this.get("song")),0===this.get("playState")?(this.set("song",b),void 0):(this.stop(),this.set("song",b),this.play(),void 0)},getSong:function(){var a;return a=this.playlist.get(this.get("song")),a?a:(a=this.playlist.getSafe(this.get("song")),this.set("song",a),this.playlist.get(a))},setSong:function(a){var b=this.playlist.get(a);b=b?b.id:!1,this.set("song",b)}}),d.player=new d.Player,d.View={},d.View.Buttons=b.View.extend({template:c.template(""),model:d.player,events:{"click .prev":function(){this.model.prev()},"click .stop":function(){this.model.stop()},"click .play":function(){this.model.play()},"click .next":function(){this.model.next()}},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this}}),d.View.PlaylistItem=b.View.extend({defaults:function(){return{songid:!1}},model:d.player,events:{click:function(){this.model.playPause(this.options.songid)}},initialize:function(){this.options=c.extend(this.defaults(),this.options),this.options.template&&(this.template=this.options.template),this.listenTo(this.model,"change",this.render)},render:function(){if(this.model.hasChanged("song")&&this.model.get("song")!=this.options.songid&&this.$el.removeClass("stopped playing paused active"),this.model.hasChanged("playState")&&this.model.get("song")==this.options.songid)switch(this.model.get("playState")){case 0:this.$el.addClass("active stopped").removeClass("playing paused");break;case 1:this.$el.addClass("active playing").removeClass("stopped paused");break;case 2:this.$el.addClass("active paused").removeClass("stopped playing")}return this}}),d.View.Label=b.View.extend({template:c.template(""),model:d.player,song:!1,initialize:function(){this.options.template&&(this.template=this.options.template),this.listenTo(this.model,"change",this.changeSong)},changeSong:function(){this.model.hasChanged("song")&&(this.song&&this.stopListening(this.song),this.song=this.model.getSong(),this.song?(this.listenToOnce(this.song.info,"hasInfo",this.render),this.song.info.getInfo()):this.render(!0))},render:function(a){return a?this.$el.html(this.template({})):this.$el.html(this.template(this.song.info.attributes)),this}}),d.View.ContinousSongData=b.View.extend({model:d.player,song:!1,initialize:function(){this.listenTo(this.model,"change",this.changeSong)},changeSong:function(){this.model.hasChanged("song")&&(this.song&&this.stopListening(this.song),this.song=this.model.getSong(),this.song?this.listenTo(this.song,"change",this.render):this.render(!0))},render:function(a){return a?this.$el.html(this.template({})):this.$el.html(this.template(this.song.info.attributes)),this}}),d.View.Position=d.View.ContinousSongData.extend({template:c.template("")}),d.View.Time=d.View.ContinousSongData.extend({template:c.template("")}),a.Stereo=d}}(window,Backbone,_,jQuery),this.Stereo=this.Stereo||{},this.Stereo.Tmpl=this.Stereo.Tmpl||{},this.Stereo.Tmpl.button=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<button class="prev"></button>\n<button class="stop"></button>\n<button class="play"></button>\n<button class="next"></button>\n';return __p},this.Stereo.Tmpl.label=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<span class="title">'+(null==(__t=title)?"":__t)+'</span>\n<span class="artist">'+(null==(__t=artist)?"":__t)+'</span>\n<span class="playlist"'+(null==(__t=playlist)?"":__t)+"</span>\n";return __p},this.Stereo.Tmpl.position=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<span class="progress">\n<span class="meter loaded">'+(null==(__t=loadpos)?"":__t)+'</span>\n<span class="meter played">'+(null==(__t=playpos)?"":__t)+"</span>\n</span>\n";return __p},this.Stereo.Tmpl.time=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<span class="time">\n    <span class="min">'+(null==(__t=min)?"":__t)+'</span>\n    <span class="sec">'+(null==(__t=sec)?"":__t)+"</span>\n</span>\n";return __p};