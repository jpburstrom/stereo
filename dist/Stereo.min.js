/* stereo
*  
* Copyright (c) 2013
* Johannes Burstr√∂m, johannes@ljud.org
* stereo may be freely distributed under the MIT license.
*/
this.Stereo=this.Stereo||{},this.Stereo.Tmpl=this.Stereo.Tmpl||{},this.Stereo.Tmpl.button=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<button class="prev"></button>\n<button class="stop"></button>\n<button class="play"></button>\n<button class="next"></button>\n';return __p},this.Stereo.Tmpl.label=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<span class="title">'+(null==(__t=title)?"":__t)+'</span>\n<span class="artist">'+(null==(__t=artist)?"":__t)+'</span>\n<span class="playlist"'+(null==(__t=playlist)?"":__t)+"</span>\n";return __p},this.Stereo.Tmpl.position=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<span class="progress">\n<span class="meter loaded">'+(null==(__t=loadpos)?"":__t)+'</span>\n<span class="meter played">'+(null==(__t=playpos)?"":__t)+"</span>\n</span>\n";return __p},this.Stereo.Tmpl.time=function(obj){obj||(obj={});{var __t,__p="";_.escape}with(obj)__p+='<span class="time">\n    <span class="min">'+(null==(__t=min)?"":__t)+'</span>\n    <span class="sec">'+(null==(__t=sec)?"":__t)+"</span>\n</span>\n";return __p},function(a,b,c,d){"use strict";var e;a.Stereo=a.Stereo||{},e=a.Stereo,e.e=c.clone(Backbone.Events),function(){var d=function(){throw new Error('A "url" property or function must be specified')};e.SongInfo=b.Model.extend({defaults:function(){return{id:!1,title:"",artist:"",playlist:""}},_isSynced:!1,initialize:function(){this.once("change",function(){this._isSynced=!0,this.trigger("hasInfo")})},urlRoot:function(){return e.options.infoURL},getInfo:function(){this._isSynced?this.trigger("hasInfo"):this.fetch()}}),e.Song=b.Model.extend({initialize:function(a,b){this.id=a,this.options=c.extend({},b),this.info=new e.SongInfo({id:a})},play:function(){this.snd||this.createSound(),this.snd.play()},pause:function(){this.snd&&this.snd.pause()},stop:function(){this.snd&&(this.snd.stop(),this.destroySound())},seek:function(){console.log("Seek: Not implemented")},createSound:function(){var b=this;this.snd=a.soundManager.createSound({id:this.options.id,url:this.url(),onload:function(){b.trigger("load",this)},onplay:function(){b.trigger("play",this)},onpause:function(){b.trigger("pause",this)},onstop:function(){b.trigger("stop",this)},onfinish:function(){b.trigger("finish",this)},onwhileloading:function(){var a=this.bytesLoaded/this.bytesTotal;b.trigger("whileloading",this,a)},onwhileplaying:function(){var a=1==this.readyState?this.durationEstimate:this.duration,c=this.position/a;b.trigger("whileplaying",this,c)}})},destroySound:function(){a.soundManager.destroySound(this.snd.id),delete this.snd},urlRoot:function(){return e.options.urlRoot},url:function(){var a,b=this.id,e=c.result(this,"urlRoot")||c.result(this.collection,"url")||d();if(this.isNew())return e;if(e){if(a=e,0===b.indexOf("http://")||0===b.indexOf("https://")||0===b.indexOf("//"))return b;0===b.indexOf("/")&&(b=b.substr(1,b.length)),a.lastIndexOf("/")!==a.length-1&&(a+="/"),b=(a&&-1!==a.lastIndexOf("/")?a.substr(0,a.lastIndexOf("/")+1):"./")+b}return b}})}(),function(){var a=function(a){var b=this.get(a);return"undefined"==typeof b?!1:this.indexOf(b)},c=function(a,b){return(b%a+a)%a},d=function(a,b){return 0===this.length?(this._index=-1,!1):(a+=b,this._repeat?(a=c(this.length,a),this._index=a,this.at(a).id):a>=this.length||0>a?(this._index=-1,!1):(this._index=a,this.at(a).id))};e.Playlist=b.Collection.extend({model:e.Song,_repeat:!0,_index:-1,getPrev:function(a){return d.call(this,a,-1)},getPrevById:function(b){var c=a.call(this,b);return!1===c?d.call(this,c,0):d.call(this,c,-1)},getNext:function(a){return d.call(this,a,1)},getNextById:function(b){var c=a.call(this,b);return!1===c?d.call(this,c,0):d.call(this,c,1)},getSafe:function(b){var c=a.call(this,b);return d.call(this,c,0)}})}(),e.playlist=new e.Playlist,e.Player=b.Model.extend({_playStateLabels:["stopped","playing","paused","loading"],playlist:e.playlist,initialize:function(){this.set("playState",0),this.set("song",!1),this.listenTo(this.playlist,"remove",function(a){a.id==this.get("song")&&(this.set("playState",0),this.set("song",!1)),a.snd&&a.destroySound()})},play:function(){this._play(this.getSongSafe())},pause:function(){var a=this.getSongSafe();a&&(this.set("playState",2),a.pause())},stop:function(){this.getSongSafe();this._stop(this.getSongSafe())},onFinish:function(){this.next(),!1===this.get("song")&&this.set("playState",0)},playPause:function(a){var b=this.get("playState");a&&a!=this.get("song")&&(b>0&&this.stop(),b=0,this.setSong(a)),1==b?this.pause():this.play()},prev:function(){this._prevNext(-1)},next:function(){this._prevNext(1)},isPlaying:function(){return 1==this.get("playState")},isStopped:function(){return 0===this.get("playState")},isPaused:function(){return 2==this.get("playState")},_play:function(a){a?(this.listenToOnce(a,"finish",this.onFinish),this.set("playState",1),a.play()):this.set("playState",0)},_stop:function(a){a&&(this.set("playState",0),this.stopListening(a),a.stop())},_prevNext:function(a){var b;this._stop(this.getSong()),b=0>a?this.playlist.getPrevById(this.get("song")):this.playlist.getNextById(this.get("song")),this.set("song",b),this._play(this.getSong())},getSong:function(){return this.playlist.get(this.get("song"))||!1},getSongSafe:function(){var a;return a=this.playlist.get(this.get("song")),a?a:(a=this.playlist.getSafe(this.get("song")),this.set("song",a),this.playlist.get(a))},setSong:function(a){var b=this.playlist.get(a);b=b?b.id:!1,this.set("song",b)},getPlayStateLabel:function(a){return a=void 0===a?this.get("playState"):a,this._playStateLabels[a]}}),e.player=new e.Player,e.View={},e.View.Buttons=b.View.extend({template:e.Tmpl.button,model:e.player,className:"stereo-buttons",events:{"click .prev":function(){this.model.prev()},"click .stop":function(){this.model.stop()},"click .play":function(){this.model.play()},"click .next":function(){this.model.next()}},initialize:function(){this.listenTo(this.model,"change",this.render),this.render()},render:function(){return this.$el.html(this.template()),this}}),e.View.Label=b.View.extend({template:e.Tmpl.label,className:"stereo-label",model:e.player,song:!1,initialize:function(){this.options.template&&(this.template=this.options.template),this.listenTo(this.model,"change",this.changeSong)},changeSong:function(){this.model.hasChanged("song")&&(this.song&&this.stopListening(this.song),this.song=this.model.getSong(),this.song?(this.listenToOnce(this.song.info,"hasInfo",this.render),this.song.info.getInfo()):this.render(!0))},render:function(){return this}}),e.View.ContinousSongData=b.View.extend({model:e.player,song:!1,initialize:function(){this.listenTo(this.model,"change",this.changeSong)},changeSong:function(){this.model.hasChanged("song")&&(this.song&&this.stopListening(this.song),this.song=this.model.getSong(),this.song?(this.listenTo(this.song,"whileloading",this.render),this.listenTo(this.song,"whileplaying",this.render)):this.empty())},empty:function(){},render:function(){return this}}),e.View.Position=e.View.ContinousSongData.extend({initialize:function(){this.data={},this.listenTo(this.model,"change",this.changeSong)},className:"stereo-position",template:e.Tmpl.position}),e.View.Time=e.View.ContinousSongData.extend({className:"stereo-time",template:e.Tmpl.time}),e.View.ClassChanger=b.View.extend({_doChangeClass:function(a){a&&this.model.hasChanged("song")&&(this.model.get("song")!=a?this.el.className=this.className:this.$el.addClass("active")),!this.model.hasChanged("playState")||a&&this.model.get("song")!=a||this.$el.removeClass(this.model.getPlayStateLabel(this.model.previous("playState"))).addClass(this.model.getPlayStateLabel())}}),e.View.Controls=e.View.ClassChanger.extend({className:"stereo-controls",views:{},initialize:function(){var a=this;return this.model=e.player,this.$el.addClass(this.className),c.each(a.options.order,function(b){a.views[b]=new e.View[b],a.views[b].render(),a.$el.append(a.views[b].$el)}),this.listenTo(this.model,"change",this.changeClass),this},changeClass:function(){return this._doChangeClass(),this}}),e.View.PlaylistItem=e.View.ClassChanger.extend({initialize:function(){this.model=e.player,this.className=this.className||this.el.className,this.options.url||(this.options.url=this.$el.data("stereo-url").toString()),this.options=c.extend(this.defaults(),this.options),this.options.template&&(this.template=this.options.template),this.listenTo(this.model,"change",this.changeClass)},defaults:function(){return{url:!1}},events:{click:function(a){a.preventDefault(),this.model.playlist.get(this.options.url)||this.model.playlist.add(this.options.url),this.model.playPause(this.options.url)}},changeClass:function(){this._doChangeClass(this.options.url)}}),e.views={},e.options||(e.options={}),c.extend(e.options,{urlRoot:"./_mp3/",infoURL:"./demo/api.php/tracks/",playlist:{onload:!1,repeat:!0,shuffle:!1},controls:{elements:"#stereo_controls",order:["Buttons","Label","Position","Time"]},links:{elements:"[data-stereo-url]"}}),e.init=function(a){var b=function(a,b,f){c.each(e.views.links,function(a){a.remove()}),b.length=0,d(a).each(f)};a=d.extend(!0,{},e.options,a),a.controls&&a.controls.elements&&(e.views.controls=[],b(a.controls.elements,e.views.controls,function(){e.views.controls.push(new e.View.Controls({el:this,order:a.controls.order}))})),a.links&&a.links.elements&&(e.views.links=[],e.e.on("init history:load-finish",function(c){!1!==c&&b(a.links.elements,e.views.links,function(){e.views.links.push(new e.View.PlaylistItem({el:this}))})})),e.e.trigger("init",a)}}(window,Backbone,_,jQuery);